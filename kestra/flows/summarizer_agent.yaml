id: summarizer_agent
namespace: redloop.security

description: AI Agent that summarizes vulnerability scan results and makes BLOCK/PASS decisions

labels:
  project: redloop
  type: security-scan
  agent: summarizer

inputs:
  - id: vulnerability_data
    type: STRING
    description: "JSON vulnerability data from Adversary Agent scan"
    required: true

  - id: repository_name
    type: STRING
    description: "Name of the scanned repository"
    defaults: "unknown"

tasks:
  - id: summarizer
    type: io.kestra.plugin.ai.agent.AIAgent
    description: "Summarize vulnerabilities and make deployment decision"
    timeout: PT3M
    retry:
      type: constant
      maxAttempt: 2
      interval: PT10S
    provider:
      type: io.kestra.plugin.ai.provider.GoogleGemini
      apiKey: "{{ secret('GEMINI_API_KEY') }}"
      modelName: gemini-2.5-flash
    
    systemMessage: |
      You are a Security Analyst AI Agent responsible for:
      1. SUMMARIZING vulnerability scan data
      2. ANALYZING risk levels based on severity
      3. MAKING DECISIONS on whether to BLOCK or PASS deployments
      
      Decision Rules:
      - BLOCK if: 1+ CRITICAL or 3+ HIGH vulnerabilities or risk_score >= 7
      - PASS otherwise
      
      Risk Score: CRITICAL=+3, HIGH=+2, MEDIUM=+1, LOW=+0.5 (cap at 10)
    
    prompt: |
      Analyze the vulnerability scan results:
      
      Repository: {{ inputs.repository_name }}
      
      Vulnerability Data:
      {{ inputs.vulnerability_data }}
      
      Provide as JSON:
      {
        "summary": "2-3 sentence executive summary",
        "risk_score": 7,
        "decision": "BLOCK",
        "reasoning": "Brief explanation",
        "vulnerability_counts": {
          "critical": 2,
          "high": 1,
          "medium": 3,
          "low": 0,
          "total": 6
        },
        "priority_fixes": ["fix 1", "fix 2", "fix 3"]
      }

  - id: log_complete
    type: io.kestra.plugin.core.log.Log
    message: "Summarizer agent completed."

errors:
  - id: error_handler
    type: io.kestra.plugin.core.log.Log
    message: "Summarizer agent failed: {{ error.message }}"
